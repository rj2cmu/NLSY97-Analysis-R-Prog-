---
title: "NLSY97 Analysis (Based on Gender)"
author: "Anum Malik, Rishabh Jain, Javier Rico Aristizabal"
date: ''
output: html_document
---

#### Package loading

```{r}
library(tidyverse)
library(knitr)
```


#### Importing the data

```{r}
# Import starting data
nlsy <- read_csv("http://www.andrew.cmu.edu/user/achoulde/94842/final_project/nlsy97/nlsy97_Nov2020.csv")
```

#### Variables present in the base data set

To learn more about the data, you can have a look at the [variable codebook file](http://www.andrew.cmu.edu/user/achoulde/94842/final_project/nlsy97/nlsy97_codebook.txt).


Here's how to rename all the variables to the Question Name abbreviation.  **You will want to change the names to be even more descriptive**, but this is a start.

```{r}
# Change column names to question name abbreviations (you will want to change these further)
colnames(nlsy) <- c("PSTRAN_GPA.01_PSTR",
    "INCARC_TOTNUM_XRND",
    "INCARC_AGE_FIRST_XRND",
    "INCARC_LENGTH_LONGEST_XRND",
    "PUBID_1997",
    "YSCH-36400_1997",
    "YSCH-37000_1997",
    "YSAQ-010_1997",
    "Marijuana_1997", #YSAQ-369_1997
    "YEXP-300_1997",
    "PerCh.Dip.20_1997", #YEXP-1500_1997
    "YEXP-1600_1997",
    "PerCh.Baby_1997", #YEXP-1800_1997
    "PerCh.Coll.Degree.30_1997", #YEXP-2000_1997
    "Sex",
    "BDATE_M_1997", #KEY_BDATE_M_1997
    "BDATE_Y_1997", #KEY_BDATE_Y_1997
    "PC8-090_1997",
    "PC8-092_1997",
    "PC9-002_1997",
    "Dep_F_1997", #PC12-024_1997
    "Dep_M_1997", #PC12-028_1997
    "CV_AGE_12/31/96_1997",
    "CV_BIO_MOM_AGE_CHILD1_1997",
    "CV_BIO_MOM_AGE_YOUTH_1997",
    "CV_CITIZENSHIP_1997",
    "CV_ENROLLSTAT_1997",
    "HH_NET_WORTH_P_1997", #CV_HH_NET_WORTH_P_1997
    "CV_YTH_REL_HH_CURRENT_1997",
    "CV_MSA_AGE_12_1997",
    "CV_URBAN-RURAL_AGE_12_1997",
    "CV_SAMPLE_TYPE_1997",
    "CV_HGC_BIO_DAD_1997",
    "CV_HGC_BIO_MOM_1997",
    "Highest.Grade_RES_DAD_1997", #CV_HGC_RES_DAD_1997
    "Highest.Grade_RES_MOM_1997", #CV_HGC_RES_MOM_1997
    "Race",
    "YSCH-6800_1998",
    "YSCH-7300_1998",
    "Ever_Used_Coca_1998", #YSAQ-372B_1998
    "YSAQ-371_2000",
    "Disorganized_2002", #YSAQ-282J_2002
    "YSAQ-282Q_2002",
    "HH_NET_WORTH_Y_2003", #CV_HH_NET_WORTH_Y_2003
    "CV_BA_CREDITS.01_2004",
    "YSAQ-000B_2004", 
    "YSAQ-373_2004",
    "Marijuana_2005", #YSAQ-369_2005
    "Children_HH_2007", #CV_BIO_CHILD_HH_2007
    "YTEL-52~000001_2007",
    "YTEL-52~000002_2007",
    "YTEL-52~000003_2007",
    "YTEL-52~000004_2007",
    "Children_HH_2009", #CV_BIO_CHILD_HH_2009
    "CV_COLLEGE_TYPE.01_2011",
    "Family_Income_2011", #CV_INCOME_FAMILY_2011
    "CV_HH_SIZE_2011",
    "CV_HH_UNDER_18_2011",
    "CV_HH_UNDER_6_2011",
    "Highest_Degree_Prior_2011.12", #CV_HIGHEST_DEGREE_1112_2011
    "Children_HH_2011", #CV_BIO_CHILD_HH_2011
    "Highest_Grade_Completed_2011", #YSCH-3112_2011
    "Height.Feet_2011", #YSAQ-000A000001_2011
    "Height.Inch_2011", #YSAQ-000A000002_2011
    "Weight.Pound_2011", #YSAQ-000B_2011
    "YSAQ-360C_2011",
    "YSAQ-364D_2011",
    "YSAQ-371_2011", 
    "Hard.drugs.DLI_2011", #YSAQ-372CC_2011
    "YSAQ-373_2011",
    "YSAQ-374_2011",
    "Industry_Code_2011", #YEMP_INDCODE-2002.01_2011
    "Children_HH_2015", #CV_BIO_CHILD_HH_2015
    "Industry_Code_2017", #YEMP_INDCODE-2002.01_2017
    "Occupation_Code_2017", #YEMP_OCCODE-2002.01_2017
    "MaritalStatus_2017", #CV_MARSTAT_COLLAPSED_2017
    "YINC-1400_2017",
    "Income",
    "YINC-1800_2017", 
    "YINC-2400_2017",
    "YINC-2600_2017",
    "YINC-2700_2017",
    "CVC_YTH_REL_HH_AGE6_YCHR_XRND",
    "CVC_SAT_MATH_SCORE_2007_XRND",
    "CVC_SAT_VERBAL_SCORE_2007_XRND",
    "CVC_ACT_SCORE_2007_XRND",
    "HH_NET_WORTH_20", #CVC_HH_NET_WORTH_20_XRND
    "HH_NET_WORTH_25", #CVC_HH_NET_WORTH_25_XRND
    "ASSETS_FINANCIAL_25", #CVC_ASSETS_FINANCIAL_25_XRND
    "ASSETS_DEBTS_20", #CVC_ASSETS_DEBTS_20_XRND
    "HH_NET_WORTH_30", #CVC_HH_NET_WORTH_30_XRND
    "CVC_HOUSE_VALUE_30_XRND",
    "CVC_HOUSE_TYPE_30_XRND",
    "ASSETS_FINANCIAL", #CVC_ASSETS_FINANCIAL_30_XRND
    "ASSETS_DEBTS_30") #CVC_ASSETS_DEBTS_30_XRND

### Set all negative values to NA.  
### THIS IS DONE ONLY FOR ILLUSTRATIVE PURPOSES
### DO NOT TAKE THIS APPROACH WITHOUT CAREFUL JUSTIFICATION
nlsy[nlsy < 0]  <- NA
```

#### A note on missing values

Here's an example of what the variable description files look like

```
T76400.00    [YSAQ-372CC]                                   Survey Year: 2011
  PRIMARY VARIABLE

 
             HAS R USED COCAINE/HARD DRUGS SINCE DLI?
 
Excluding marijuana and alcohol, since the date of last interview, have you used
any drugs like cocaine, crack, heroin, or crystal meth, or any other substance 
not prescribed by a doctor, in order to get high or to achieve an altered state?
 
UNIVERSE: All except prisoners in an insecure environment
 
     215       1 YES   (Go To T76401.00)
    7023       0 NO
  -------
    7238
 
Refusal(-1)           74
Don't Know(-2)        26
TOTAL =========>    7338   VALID SKIP(-4)      85     NON-INTERVIEW(-5)    1561
 
Min:              0        Max:              1        Mean:                 .03
 
Lead In: T76397.00[Default] T76399.00[Default]  T76398.00[0:0]
Default Next Question: T76403.00
```

This description says that the numbers -1, -2, -4 and -5 all have a special meaning for this variable.  They denote different types of missingness.  You can recode all of these to `NA`, but you should also think about whether the different missigness indicators are in some way informative.  (i.e., if someone refuses to answer questions related to drug use, might this inform us about their income?) 

#### Getting to know our two main variables.

In the previous chunk of code we have appropriately renamed the variables corresponding to `sex`, `race` and `income` (as reported on the 2017 survey).  Let's have a quick look at what we're working with.

```{r}
table(nlsy$Sex)

table(nlsy$Race)
```

The data codebook tells us that the coding for sex is `Male = 1`, `Female = 2`.  For the race/ethnicity variable, the coding is:

```
1 Black
2 Hispanic
3 Mixed Race (Non-Hispanic)
4 Non-Black / Non-Hispanic
```

You'll want to do some data manipulations to change away from the numeric codings to more interpretable labels. 

```{r}
summary(nlsy$Income)

# Histogram
qplot(nlsy$Income)
```

The income distributing is right-skewed like one might expect.  However, as indicated in the question description, the income variable is *topcoded* at the 2% level.  More precisely,

```{r}
n.topcoded <- with(nlsy, sum(Income == max(Income, na.rm = TRUE), na.rm = TRUE))
n.topcoded
```

`r n.topcoded` of the incomes are topcoded to the maximum value of `r max(nlsy$income, na.rm = TRUE)`, which is the average value of the top `r n.topcoded` earners. You will want to think about how  to deal with this in your analysis.

<font color="#157515">
We begin our analysis by including only the variables we have shortlisted into a data-set for consistency. The trends that seem most interesting to us for further exploration in assessing what impacts income gap between genders are: Marital Status (`MaritalStatus_2017`), Highest Grade Completed, Industry, Number of Biological Children, House-hold Net Worth at 30 and a digression towards Marijuana Use. Furthermore, we would like to see whether there is an impact of physical appearance on the income gap by using Body Mass Index (BMI). 
</font>



```{r}
nlsy.recode <- nlsy %>%
  mutate(Sex = recode_factor(Sex,
                                `1` = "Men",
                                `2` = "Female",
                                `0` = "No Information"))
nlsy.recode <- select(nlsy.recode, Marijuana_1997, PerCh.Dip.20_1997, PerCh.Baby_1997, PerCh.Coll.Degree.30_1997, Sex, BDATE_M_1997, BDATE_Y_1997, Dep_F_1997, Dep_M_1997, HH_NET_WORTH_P_1997, 
 Highest.Grade_RES_DAD_1997,Highest.Grade_RES_MOM_1997,Ever_Used_Coca_1998, Disorganized_2002,
 HH_NET_WORTH_Y_2003,
 Marijuana_2005, 
  Children_HH_2007,
  Children_HH_2009, 
  Family_Income_2011, 
  Highest_Degree_Prior_2011.12,
  Children_HH_2011, 
  Highest_Grade_Completed_2011,
  Height.Feet_2011,
  Height.Inch_2011,
  Weight.Pound_2011,
  Hard.drugs.DLI_2011,
  Industry_Code_2011,
  Children_HH_2015,
  Industry_Code_2017,
  Occupation_Code_2017,
  MaritalStatus_2017,
  Income,
  HH_NET_WORTH_20,
  HH_NET_WORTH_25,
  ASSETS_FINANCIAL_25,
  ASSETS_DEBTS_20,
  HH_NET_WORTH_30,
  ASSETS_FINANCIAL,
  ASSETS_DEBTS_30
 )
```

<font color="#157515">
As we are going to be analyzing income across all our variables, we will be removing NAN values from the rows within that variable. 
</font>

```{r}
nlsy.recode <- filter(nlsy.recode, !is.na(Income)) # 
```  

<font color="#157515">
Let's assess a summary table of income across gender. 
</font>

```{r}
income.gender <- nlsy.recode %>%
  group_by(Sex) %>%
  summarize(average.income = mean(Income), 
            median.income = median(Income))
respondents <- table(nlsy.recode$Sex)
kable(income.gender, format = "markdown", digits = 3)
```
<font color="#157515">
When assessing the data via a preliminary scan, we see that the average income for men is `r income.gender$average.income[1]` and the average income for women is `r income.gender$average.income[2]`, which amounts to a difference of `r income.gender$average.income[1] - income.gender$average.income[2]`.

</font>

```{r}
ggplot(nlsy.recode, aes(Income, fill = Sex)) + geom_histogram(alpha = 0.5, position = 'identity') +
  labs (x = "Income", y = "Number of Respondents")
```

<font color="#157515">
After removing the NAN values in income. the number of female respondents is (`r respondents[2]`) compared to men (`r respondents[1]`). With the histogram, we see as the income progresses on the x-axis; men take the lead in reporting higher salaries; whereas, in the lower range, women seem to be the higher number of respondents. Furthermore, it is important to note that it seems like the data is left-skewed. Let's move on to assess income gaps and gender with other variables. First up, is Marital Status.

<b>Income, Sex, and Marital Status<b>:
Would you expect a single man to earn more than a single woman? Or could a divorced man earn more than a divorced woman? Our expectation would be that marital status should not affect income gap. There could; however, be a dent in the income gap if a married woman decides to take the role of a home-maker or a part-time job as per societal expectations. Let's find out.
</font>

```{r}
nlsy.recode <- filter(nlsy.recode, !is.na(MaritalStatus_2017)) #removing NAN values or no responses from our analysis variable. 

nlsy.recode <-mutate(nlsy.recode, MaritalStatus_2017 = recode_factor(MaritalStatus_2017,
                                `0` = "Never-married",
                                `1` = "Married",
                                `2` = "Separated",
                                `3` = "Divorced",
                                `4` = "Widowed",
                                `NA` = "Other"))

income.gender.2<- nlsy.recode %>%
  group_by(Sex, MaritalStatus_2017) %>%
  summarize(average.income = mean(Income))

income.gender.2
```

<font color="#157515">
The simple summary showcases that the variable is worth exploring. In most instances across marital groups, the average income of men is higher than women. By running a t-test we can get more concrete information. 
</font>

```{r}

income.gap.marital <- nlsy.recode %>%
  group_by(MaritalStatus_2017) %>%
  summarize(Income.gap = mean(Income[Sex == "Men"]) -  mean(Income[Sex == "Female"]),
            lower = (t.test(x = Income[Sex == "Men"], y = Income[Sex == "Female"]))$conf.int[1],
            upper = (t.test(x = Income[Sex == "Men"], y = Income[Sex == "Female"]))$conf.int[2],
            is.significant = as.numeric(t.test(Income ~ Sex)$p.value < 0.05), .groups = "keep")

income.gap.marital
```

<font color="#157515">
The income.gap variable shows us the difference between average salaries of men and women in the specified marital groups. 
</font>

```{r}
marital.gap <- ggplot(data = income.gap.marital,aes(x = reorder(MaritalStatus_2017, Income.gap), y = Income.gap))
marital.gap + geom_bar(position="dodge", stat="identity")  + geom_errorbar(aes(ymin = lower, ymax = upper), width=.2, position = position_dodge(0.9)) +  theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + labs(x = "Marital Status", y = "Income Gap Between Genders")
```
<font color="#157515">
The error bars are below the 0-axis, therefore according to the data the results are not statistically significant. Running a regression model should corroborate our initial findings. First, we will run a simple regression on just income and sex; following which we will include marital status in the model
</font>

```{r}
lm.income.sex <- lm(Income ~ Sex, data = nlsy.recode)
summary(lm.income.sex)
```
<font color="#157515">
From the simple regression, it seems that on average women earn `r round(coef(lm.income.sex)["SexFemale"], 0)*-1` less than men. This seems to be statistically significant with a p-value of `r lm.income.sex$p.value`
</font>

```{r}
lm.income.sex.marital <- lm(Income ~ Sex + MaritalStatus_2017, data = nlsy.recode)
summary(lm.income.sex.marital)
```

It seems that on average married person earns `r round(coef(lm.income.sex.marital)["MaritalStatus_2017Married "], 0)*` more than the baseline (never-married). This seems to be statistically significant with a p-value of `r lm.income.sex.marital$p.value`.
</font>

```{r}
anova(lm.income.sex , lm.income.sex.marital)
```

<font color="#157515">
From the analysis of variance table, we see that including marital status to gender has an impact on the income gap and it is significant.   
</font>

```{r}
lm.marital.interact <- update(lm.income.sex.marital, .~. + MaritalStatus_2017 * Sex)
summary(lm.marital.interact)
```
<font color="#157515">
This interactive model corresponds to differences in earnings across gender and marital status that are not accounted for by a model that assumes independent effects for Marital status and gender. For instance, here we only see that the income difference among married men and married women is $16396 less than the difference between single men and single women. However, we cannot conclude that marital status as a whole is a factor that is highly associated with the income gap between men and women. 
</font>


<font color="#157515">
A natural shift from marriage would be children. Income, sex and number of children. Would you expect income gap to decrease regardless of gender as the family size increases? There are multiple theories that come into play here. Perhaps contributing factors could be a sense of income security leading to both genders having more children. On the flip side, the gap could exacerbate given that more and more women on average might switch to more lax jobs or choose to stay at home altogether. We think this is an interesting variable to explore. Additionally, we want to see whether a larger family size is correlated with a lack of education leading to a lower income across the board. If women are educated, they might have fewer children and that might contribute to their higher income and a reduction in the gap. 

In order to , we have chosen the "biological children in household data" from 2009. We checked the data and it seemed to be replicated for all the years. We will run simple summaries and check for associations, next we will run a simple regression model to check for significance, and finally explore if there are any interactions between highest grade completed, number of children, sex and income.  

</font>

```{r}
num.bio.child <- nlsy.recode %>%
  group_by(Children_HH_2009, Sex) %>%
  summarize(average.income = mean(Income, na.rm = TRUE))

num.bio.child <- filter(num.bio.child, !is.na(average.income),!is.na(Children_HH_2009))
num.bio.child
```
<font color="#157515">
We see a pattern, men's income on average increases up to 3 biological children. The gap in income between men and women remains; let's leave gender out of it and see if there's a variance in average income regardless as the number of children increase. 
</font>

```{r, fig.height = 4, fig.width = 9}
ggplot(data = num.bio.child, aes(x = Children_HH_2009, y = average.income, fill = Sex)) + 
  geom_bar(position="dodge", stat="identity") +
  theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + 
  labs( x = "Number of Biological Children", y = "Average Income ($)")
```

<font color="#157515">
We see a pattern, men's income on average increases up to 3 biological children. The gap in income between men and women remains; let's leave gender out of it and see if there's a variance in average income regardless as the number of children increase. 
</font>


```{r, fig.height = 4, fig.width = 9}
ggplot(data = num.bio.child, aes(x = Children_HH_2009, y = average.income)) + 
  geom_bar(position="dodge", stat="identity") +
  theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + 
  labs( x = "Number of Biological Children", y = "Average Income ($)")
```

<font color="#157515">
Again, regardless of gender the pattern showcases that the average income increases up to 3 children. Let's get to the notorious question of income gap! For this analysis, we will take out the outlier reported for people with six children or more ($2,500 for men).
</font>

```{r}
nlsy.child.recode <- filter(nlsy.recode, !(Children_HH_2009 == 6))

gap.data.conf.child <- nlsy.child.recode %>%
  group_by(Children_HH_2009) %>%
  summarize(income.gap = mean(Income[Sex == "Men"], na.rm = TRUE) -
              mean(Income[Sex == "Female"], na.rm = TRUE),
            lower = t.test(Income ~ Sex)$conf.int[1],
            upper = t.test(Income ~ Sex)$conf.int[2],
            is.significant = as.numeric(t.test(Income ~ Sex)$p.value < 0.05), .groups = "keep")
gap.data.conf.child
```

```{r}
#Plot, with error bars
ggplot(data = gap.data.conf.child, aes(x = Children_HH_2009, y = income.gap,
                            fill = is.significant)) +
  geom_bar(stat = "identity") +
  xlab("Biological Children in Household") + 
  ylab("Income gap($)") +
  ggtitle("Income gap between men and women, by children") + 
  guides(fill = FALSE) +
  geom_errorbar(aes(ymax = upper, ymin = lower), width = 0.1, size = 1) +
  theme(text = element_text(size=12)) 
```

<font color="#157515">
The graph above shows that the income gap seems to be the widest with three biological children in the household. Since the error bars do not cross the 0-axis, it's statistically significant.     
</font>

```{r}
#running a simple regression model for Income, Biological Children and Sex 
income.lm.bio.child.sex <- lm(Income ~ Sex + Children_HH_2009, data = nlsy.child.recode)
summary(income.lm.bio.child.sex)
```
<font color="#157515">
From the simple regression, it seems that on average with each additional child respondents earn $`r round(coef(income.lm.bio.child.sex)["Children_HH_2009"], 0)` more. This is a very small number and is statistically insignificant. 
</font>

```{r}
lm.child.interact <- update(income.lm.bio.child.sex , .~. + Children_HH_2009 * Sex)
summary(lm.child.interact)
```

<font color="#157515">
When we put these variables to the test, it shows a highly significant finding. This interactive model corresponds to differences in earnings across gender and biological children in household that are not accounted for by a model that assumes independent effects of each. It seems that on average the income difference between women with children and men with children is $`r round(coef(lm.child.interact )["SexFemale:Children_HH_2009"], 0)*-1` less than the difference between women and men that don't have children. This finding is highly significant according to the data. It's also interesting to note that now each additional child brings in `r round(coef(lm.child.interact )["Children_HH_2009"], 0)` more with income and it is statistically significant in the interaction.
</font>


```{r}
nlsy.child.recode <- mutate(nlsy.child.recode, Children_HH_2009 = recode_factor(Children_HH_2009,
                                `0` = "Child.0",
                                `1` = "Child.1",
                                `2` = "Child.2",
                                `3` = "Child.3",
                                `4` = "Child.4",
                                `5` = "Child.5"))

income.lm.bio.child.sex.factor <- lm(Income ~ Sex + Children_HH_2009, data = nlsy.child.recode)
summary(income.lm.bio.child.sex.factor)
```

<font color="#157515">
Income, Sex, and Highest Grade Completed:
We expect to see an impact on income gap and the highest degree completed. We want to explore whether this difference prevails regardless of gender. The question here would be, does it matter whether you are male or female if the highest degree you have completed is the same across both genders? Our first approach is to check the continuity of the data of highest grade against income without re-coding it as a factor variable. We take advantage of the fact that the Highest Degree Completed variable is in a chronological order and we skipped the number 95 where the respondents had mentioned their degree to be "ungraded". 
 </font>

```{r}
ggplot(data = nlsy.recode, aes(x = Highest_Grade_Completed_2011, y = Income , colour = Sex )) + geom_point() + stat_smooth(method = 'loess', formula = y ~ x, size = 1) + theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + xlim(0,22) + 
  labs( x = "Highest Degree Completed", y = "Average Income ($)")
```

<font color="#157515">
In the graph, we can see an evolution of the income gap between men and women, depending on the highest degree completed. The income difference between men and women becomes smaller as the degree completed approaches 12, that is "12th grade" or equivalent to a high school diploma. Before exploring this further, we want to analyze other interesting variables such as marijuana consumption with highest degree completed, sex and average income. 
</font>

```{r}
nlsy.recode <- nlsy.recode %>%
  mutate(Marijuana_1997 = recode_factor(Marijuana_1997,
                                             `0` = "No",
                                             `1` = "Yes"))

ggplot(data = nlsy.recode, aes(x = Highest_Grade_Completed_2011, y = Income , colour = Marijuana_1997, shape = Sex)) + geom_point() + stat_smooth(method = 'lm', formula = y ~ x, size = 1, se = FALSE) +
  theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + xlim(0,22) + 
  labs( x = "Highest Degree Completed", y = "Average Income ($)")
```
<font color="#157515">
This graph shows the income in 2011 of those who had consumed marijuana by 1997, differentiated by gender across different education levels. As also evidenced in the previous graph which didn't include the marijuana consumption, the gap between those at high school level is smaller to those who have completed lower levels of education. Between 12 and 17 years of study: high school or higher, having consumed marijuana by 1997 doesn't present a difference in income for 2011, but the income gap by gender still remains. This is just an interesting pattern we wanted to explore; however, we cannot state that our claim is conclusive. 
</font>

```{r}
nlsy.recode <- mutate(nlsy.recode,Highest_Grade_Completed_2011 = recode_factor(Highest_Grade_Completed_2011,
                                             `0` = "NONE",
                                             `1` = "1ST GRADE",
                                             `2` = "2ND GRADE",
                                             `3` = "3RD GRADE",
                                             `4` = "4TH GRADE",
                                             `5` = "5TH GRADE",
                                             `6` = "6TH GRADE",
                                             `7` = "7TH GRADE",
                                             `8` = "8TH GRADE",
                                             `9` = "9TH GRADE",
                                             `10` = "10TH GRADE",
                                             `11` = "11TH GRADE",
                                             `12` = "12TH GRADE",
                                             `95` = "UNGRADED",
                                             `13` = "1ST YEAR COLLEGE",
                                             `14` = "2ND YEAR COLLEGE",
                                             `15` = "3RD YEAR COLLEGE",
                                             `16` = "4TH YEAR COLLEGE",
                                             `17` = "5TH YEAR COLLEGE",
                                             `18` = "6TH YEAR COLLEGE",
                                             `19` = "7TH YEAR COLLEGE",
                                             `20` = "8TH YEAR COLLEGE OR MORE"))

nlsy.recode <- filter(nlsy.recode, !is.na(Marijuana_1997))
income.lm.sex.degree <- lm(Income ~ Sex + Highest_Grade_Completed_2011, data = nlsy.recode)
summary(income.lm.sex.degree)
```

```{r}
income.lm.sex.degree.m <- lm(Income ~ Sex + Highest_Grade_Completed_2011 + Marijuana_1997, data = nlsy.recode)
summary(income.lm.sex.degree.m)
```

<font color="#157515">
All else considered constant, those that used marijuana by 1997 compared to the baseline of those that did not earn approximately `r round(abs(coef(income.lm.sex.degree.m)["Marijuana_1997Yes"]),0)` more. However, this difference is not statistically significant for our analysis. Marijuana use was interesting to explore; but for the purpose of further analysis; it's best to drop this variable and check if there's an interaction between gender and highest degree completed. 
</font>

```{r}
nlsy.lm.interact.degree <- update(income.lm.sex.degree, . ~ . + Highest_Grade_Completed_2011*Sex)
summary(nlsy.lm.interact.degree)
```

<font color="#157515">
This interactive model corresponds to differences in earnings across gender and the highest grade completed that are not accounted for by a model that assumes independent effects for highest grade completed and gender. 

In one of the instances, we see that the income difference among men whose highest grade completed is 2nd year of college and women whose highest grade completed is 2nd year of college is $25523 more than the difference between men and women in the baseline group. However, this difference does not seem to be statistically significant as is the interaction with the rest of the associations in this model. 
</font>

```{r ,fig.height = 4, fig.width = 8}
ggplot(data = income.industries, aes(x = Industry_Code_2017, y = average.income, colour = Sex )) + 
  geom_point() + stat_smooth(method = 'lm', size = 1, fullrange = TRUE) + 
  theme(axis.text.x=element_text(angle =- 90, vjust = 0.5)) + ylab("Average Income")
```
```{r, fig.height = 4, fig.width = 8}
ggplot(data = nlsy.recode, aes(x = Income, y = Highest_Grade_Completed_2011 , colour = Industry_Code_2017, shape = Sex )) + geom_point() + stat_smooth(method = 'loess', formula = y ~ x, size = 1) + theme(axis.text.x=element_text(angle =- 90, vjust = 0.5)) + ylim(0,22)
```
```{r}
income.lm.grade.ind.sex <- lm(Income ~ Highest_Grade_Completed_2011 + Industry_Code_2017 + Sex, data = nlsy.recode)
summary(income.lm.grade.ind.sex)
```



```{r}
nlsy.recode <- data_frame(nlsy.recode)
industry.decoder <- c(rep(' AGRICULTURE, FORESTRY AND FISHERIES',121),rep('NA',79),
                    rep(' MINING',121),rep('NA',79),rep(' UTILITIES',121),
                    rep('NA',79),rep('CONSTRUCTION',1),rep('NA',299),
                    rep(' MANUFACTURING',2921),rep('NA',79),rep(' WHOLESALE TRADE',521),
                    rep('NA',79),rep(' RETAIL TRADE',1121),rep('NA',99),
                    rep(' ARTS, ENTERTAINMENT AND RECREATION SERVICES',1),
                    rep('NA',179),rep(' TRANSPORTATION AND WAREHOUSING',321),
                    rep('NA',79),rep(' INFORMATION AND COMMUNICATION',311),
                    rep('NA',89),rep(' FINANCE, INSURANCE, AND REAL ESTATE',321),
                    rep('NA',79),rep(' PROFESSIONAL AND RELATED SERVICES',521),
                    rep('NA',69),rep(' EDUCATIONAL, HEALTH, AND SOCIAL SERVICES',611),
                    rep('NA',89),rep(' ENTERTAINMENT, ACCOMODATIONS, AND FOOD SERVICES',131),
                    rep('NA',79),rep(' OTHER SERVICES',521),rep('NA',79),
                    rep(' PUBLIC ADMINISTRATION',221),rep('NA',79),
                    rep(' ACTIVE DUTY MILITARY',221),rep('NA',59),rep(' ACS SPECIAL CODES',41))
names(industry.decoder)<-170:9990

decode <- function(number) {
  if (is.na(industry.decoder[as.character(number)])) 
  {  text <- "OTHER"   }
  else {
    text <- industry.decoder[as.character(number)]   }
  return (text)}

nlsy.recode[["Industry_Code_2017"]] <- sapply(nlsy.recode[["Industry_Code_2017"]], decode)

income.industries <- nlsy.recode %>%
  group_by(Sex, Industry_Code_2017) %>%
  summarize(average.income = mean(Income, na.rm = TRUE), .groups = 'keep')

income.industries



```


```{r, fig.height = 4, fig.width = 8}
ggplot(data = income.gender.2, aes(x = MaritalStatus_2017, y = average.income, fill = Sex)) + 
  geom_bar(stat = "identity") + facet_grid(.~Sex) + coord_flip() + 
  theme(axis.text.x=element_text(angle =- 90, vjust = 0.5), legend.position = "none") + 
  labs( x = "Marital Status", y = "Average Income" )
```
```{r}
ggplot(data = nlsy.recode, aes(x = Highest_Grade_Completed_2011, y = Income , colour = Sex )) + geom_point() + stat_smooth(method = 'loess', formula = y ~ x, size = 1) + theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + xlim(0,22) + 
  labs( x = "Highest Degree Completed", y = "Average Income ($)")
```
<font color="#157515">
In the graph we can see an evolution of the income gap between men and women, depending on the highest degree completed (not using the grades as a discrete factor variable here). We don't consider in the graph the data related to non-completed undergrad studies. It evidences that for those who are close to 12 years of completed studies, equivalent to high school completion, the income is lower in average to those who didn't completed high school studies, and to those who have higher degree levels. It also shows that the income gap is in average lower between those who are close to 12 years of studies.
</font>


```{r}
nlsy.recode <- nlsy.recode %>%
  mutate(Marijuana_1997 = recode_factor(Marijuana_1997,
                                             `0` = "No",
                                             `1` = "Yes"))

ggplot(data = nlsy.recode, aes(x = Highest_Grade_Completed_2011, y = Income , colour = Marijuana_1997,shape = Sex)) + geom_point() + stat_smooth(method = 'loess', formula = y ~ x, size = 1) + theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + xlim(0,22) + 
  labs( x = "Highest Degree Completed", y = "Average Income ($)")
```


<font color="#157515">
This graph shows how the income in 2011 of those who had consumed marijuana by 1997, differenciate by gender across different education levels.As also evidenced in the previous graph which didn't include the marijuana consumption, the gap between those at high school level is larger to those between a higher education level.
Between 12 and 17 years of study: high school or higher, having consumer marijuana by 1997 doesn't present a difference in income for 2011, but the income gap by gender still remains.
</font>


```{r}
confint(income.lm.grade.ind.sex, parm = "Industry_Code_2017")
confint(income.lm.grade.ind.sex, parm = "Highest_Grade_Completed_2011")
confint(income.lm.grade.ind.sex, parm = "Sex")
```


```{r}
anova(update(income.lm.grade.ind.sex, . ~ . - Sex), income.lm.grade.ind.sex)
```





<font color="#157515">
Interesting, could adding the highest degree earned to the existing model exacerbate or mitigate the income gap between men and women?
</font>

```{r}
income.lm.bio.child.sex.edu <- lm(Income ~ Children_HH_2009 + Sex + Highest_Grade_Completed_2011, data = nlsy.recode)
summary(income.lm.bio.child.sex.edu)
```

<font color="#157515">
Though part of the unconventional debate, there are studies that examine the impact of physical appearance on the income gap. To narrow down our analysis, we are going to assess physical appearance through the Body Mass Index (BMI) parameters stated below and evaluate it with the assumption that those that fall within a normal range are physically attractive and thus might earn more regardless of gender. Let's explore this further. 

If your BMI is less than 18.5: it falls within the underweight range. 
If your BMI is 18.5 to <25, it falls within the normal. 
If your BMI is 25.0 to <30, it falls within the overweight range. 
If your BMI is 30.0 or higher, it falls within the obese range.

</font>

```{r}
nlsy.recode <- filter(nlsy.recode, !is.na(Height.Inch_2011), !is.na(Weight.Pound_2011), !is.na(Height.Feet_2011))
nlsy.recode$bmi <- (703 * nlsy.recode$Weight.Pound_2011) / ((nlsy.recode$Height.Feet_2011*12) + nlsy.recode$Height.Inch_2011)**2
```

```{r}
ggplot(nlsy.recode, aes(x=bmi, y=Income, color=Sex)) + geom_point(size=0.2) + xlim(10,60) + geom_smooth(method="lm", se=FALSE)
```
<font color="#157515">
The graph above shows us that an income gap remains between men and women across varying BMIs. As the BMI increases, the income gap widens. This can also be analyzed through a simple regression model as well. 
</font>

```{r}
lm.bmi <- lm(Income ~ Sex + bmi, data = nlsy.recode)
summary(lm.bmi)
```


```{r}
anova(update(lm.bmi, . ~ . - bmi), lm.bmi)
```

```{r}
lm.bmi.interact <- update(lm.bmi, . ~ . + Sex*bmi)

summary(lm.bmi.interact)
```

<font color="#157515">
All else constant, we see that women with higher BMI have a disproportionate gap versus men with higher BMI. [recheck] 
</font>

```{r}
used.coca <- nlsy.recode %>%
  group_by(Ever_Used_Coca_1998, Sex) %>%
  summarize(mean = mean(Income),
            lower = t.test(Income, na.rm = TRUE)$conf.int[1],
            upper = t.test(Income, na.rm = TRUE)$conf.int[2],
            is.signif = as_factor(
              if (lower<0 & upper>0){
                is.signif = 0
              } else {
                is.signif = 1
              }
            ), .groups = 'keep')
used.coca

```
```{r}
num.bio.child <- nlsy.recode %>%  
  group_by(Children_HH_2009, Sex) %>%
  summarize(mean = mean(Income[Sex == "Men"]) -  mean(Income[Sex == "Female"]),
            lower = t.test(x = Income[Sex == "Men"],
                            y = Income[Sex == "Female"])$conf.int[1],
            upper = t.test(x = Income[Sex == "Men"],
                            y = Income[Sex == "Female"])$conf.int[2], .groups = "keep")
```

```{r}
education.indicator <- filter(nlsy.recode, !(nlsy.education$Highest_Grade_Completed_2011 == "NONE"),
                              !(nlsy.education$Highest_Grade_Completed_2011 == "1ST GRADE"),
                              !(nlsy.education$Highest_Grade_Completed_2011 == "2ND GRADE"),
                              !(nlsy.education$Highest_Grade_Completed_2011 == "3RD GRADE"),
                              !(nlsy.education$Highest_Grade_Completed_2011 == "4TH GRADE"),
                              !(nlsy.education$Highest_Grade_Completed_2011 == "5TH GRADE"),
                              !(nlsy.education$Highest_Grade_Completed_2011 == "6TH GRADE"),
                              !(nlsy.education$Highest_Grade_Completed_2011 == "7TH GRADE"),
                              !(nlsy.education$Highest_Grade_Completed_2011 == "UNGRADED"),
                              !is.na(nlsy.education$Highest_Grade_Completed_2011),
                              !is.na(nlsy.education$Income))
ed.indicator <- education.indicator %>%
  group_by(Highest_Grade_Completed_2011) %>%
  summarize(mean = mean(Income),
            lower = t.test(Income)$conf.int[1],
            upper = t.test(Income)$conf.int[2],
            is.signif = as_factor(
              if (lower<0 & upper>0){
                is.signif = 0
              } else {
                is.signif = 1
              }
              ), .groups = 'keep')

```


```{r}
education.indicator <- mutate(ed.indicator,
                     Highest_Grade_Completed_2011 = factor(Highest_Grade_Completed_2011,
                     levels = c("8TH GRADE", "9TH GRADE", "10TH GRADE",
                     "11TH GRADE", "12TH GRADE", "1ST YEAR COLLEGE", "2ND YEAR COLLEGE",
                     "3RD YEAR COLLEGE", "4TH YEAR COLLEGE", "5TH YEAR COLLEGE", "6TH YEAR COLLEGE",
                     "7TH YEAR COLLEGE", "8TH YEAR COLLEGE OR MORE")))
nlsy.education.plot <- ggplot(data = ed.indicator,
                              aes(x = Highest_Grade_Completed_2011, y = mean,
                                  fill = is.signif))
nlsy.education.plot + geom_bar(position="dodge", stat="identity") +
  guides(fill = guide_legend(title = "Statistically Significant")) +
  geom_errorbar(aes(ymin = lower, ymax = upper), 
                width=.2, position = position_dodge(0.9)) +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5))
```

```{r}
worth.30.means <- nlsy.recode %>%
  group_by(Sex) %>%
  summarize(hh.worth.30 = mean(HH_NET_WORTH_30, na.rm = TRUE),
            lower = t.test(HH_NET_WORTH_30, na.rm = TRUE)$conf.int[1],
            upper = t.test(HH_NET_WORTH_30, na.rm = TRUE)$conf.int[2],
            is.signif = as_factor(
              if (lower<0 & upper>0){
                is.signif = 0
              } else {
                is.signif = 1
              }
            ), .groups = 'keep')
worth.30.means.plot <- ggplot(data = worth.30.means,
                              aes(x = Sex, y = hh.worth.30,
                                  fill = Sex))
worth.30.means.plot + geom_bar(position="dodge", stat="identity") +
  guides(fill = guide_legend(title = "Sex")) +
  geom_errorbar(aes(ymin = lower, ymax = upper), 
                width=.2, position = position_dodge(0.9)) +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5))
```
```{r}
ggplot(data = nlsy.recode, aes(x = HH_NET_WORTH_30, y = Income , colour = Sex )) + geom_point() + stat_smooth(method = 'loess', formula = y ~ x, size = 1) + theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + 
  labs( x = "Household worth at 30 years old", y = "Average Income ($)")
```
```{r}
ggplot(data = nlsy.recode, aes(x = Income, y = HH_NET_WORTH_30 , colour = Sex )) + geom_point() + stat_smooth(method = 'loess', formula = y ~ x, size = 1) + theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + 
  labs( x = "Average Income ($)", y = "Household worth at 30 years old")
```
```{r}
income.hh_worth.lm <- lm(Income ~ Sex + HH_NET_WORTH_30, data = nlsy.recode)
summary(income.hh_worth.lm)
```

```{r}
anova(update(income.hh_worth.lm, . ~ . - Sex), income.hh_worth.lm)
```

```{r}
nlsy.recode.inc.filt <- filter(nlsy.recode, !(Income > 150000))

hh30_Income.plot <- ggplot(data = nlsy.recode.inc.filt, aes(x = HH_NET_WORTH_30, y = Income , colour = Sex )) 

hh30_Income.plot + geom_point() + stat_smooth(method = 'lm', formula = y ~ x, size = 1) +
  theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) +
  labs( x = "Household worth at 30 years old", y = "Average Income ($)")
```

```{r}
Income_hh30.plot <- ggplot(data = nlsy.recode.inc.filt, aes(x = Income, y = HH_NET_WORTH_30 , colour = Sex )) 
Income_hh30.plot + geom_point() + stat_smooth(method = 'lm', formula = y ~ x, size = 1) + theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + 
  labs( x = "Average Income ($)", y = "Household worth at 30 years old")
```
```{r}
income.hh_worth.lm <- lm(Income ~ Sex + HH_NET_WORTH_30 + Highest_Grade_Completed_2011, data = nlsy.recode.inc.filt)
summary(income.hh_worth.lm)
```

```{r}
income.hh_worth.lm.interact <- update(income.hh_worth.lm, . ~ . + Sex*HH_NET_WORTH_30)

summary(income.hh_worth.lm.interact)
```
```{r}
income.hh_worth.marijuana.lm <- lm(Income ~ Sex + HH_NET_WORTH_30 + Marijuana_1997, data = nlsy.recode.inc.filt)
summary(income.hh_worth.marijuana.lm)
```
```{r}
income.hh_worth.marijuana.lm.interact <- update(income.hh_worth.marijuana.lm, . ~ . + Sex*Marijuana_1997)
summary(income.hh_worth.marijuana.lm.interact)
```
