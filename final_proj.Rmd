---
title: "NLSY97 Snapshot Analysis (Based on Gender)"
author: "Anum Malik (anumm), Rishabh Jain (rj2), Javier Rico Aristizabal (jricoari)"
date: '14th December 2020, Monday'
output: html_document
---

```{r set-options, echo=FALSE, cache=FALSE}
#increasing the page width
options(width = 350)
```

#### Package loading

```{r, warning = FALSE}
library(tidyverse)
library(knitr)
```


#### Importing the data

```{r, warning = FALSE}
# Import starting data
nlsy <- read_csv("http://www.andrew.cmu.edu/user/achoulde/94842/final_project/nlsy97/nlsy97_Nov2020.csv")
```

#### Variables present in the base data set

To learn more about the data, you can have a look at the [variable codebook file](http://www.andrew.cmu.edu/user/achoulde/94842/final_project/nlsy97/nlsy97_codebook.txt).

<font color="#800000">
We will rename all the variables to an abbreviation to make them more descriptive. 
</font>
```{r, warning = FALSE}
# Change column names abbreviations
colnames(nlsy) <- c("PSTRAN_GPA.01_PSTR",
    "INCARC_TOTNUM_XRND",
    "INCARC_AGE_FIRST_XRND",
    "INCARC_LENGTH_LONGEST_XRND",
    "PUBID_1997",
    "YSCH-36400_1997",
    "YSCH-37000_1997",
    "YSAQ-010_1997",
    "Marijuana_1997", #YSAQ-369_1997
    "YEXP-300_1997",
    "PerCh.Dip.20_1997", #YEXP-1500_1997
    "YEXP-1600_1997",
    "PerCh.Baby_1997", #YEXP-1800_1997
    "PerCh.Coll.Degree.30_1997", #YEXP-2000_1997
    "Sex",
    "BDATE_M_1997", #KEY_BDATE_M_1997
    "BDATE_Y_1997", #KEY_BDATE_Y_1997
    "PC8-090_1997",
    "PC8-092_1997",
    "PC9-002_1997",
    "Dep_F_1997", #PC12-024_1997
    "Dep_M_1997", #PC12-028_1997
    "CV_AGE_12/31/96_1997",
    "CV_BIO_MOM_AGE_CHILD1_1997",
    "CV_BIO_MOM_AGE_YOUTH_1997",
    "CV_CITIZENSHIP_1997",
    "CV_ENROLLSTAT_1997",
    "HH_NET_WORTH_P_1997", #CV_HH_NET_WORTH_P_1997
    "CV_YTH_REL_HH_CURRENT_1997",
    "CV_MSA_AGE_12_1997",
    "CV_URBAN-RURAL_AGE_12_1997",
    "CV_SAMPLE_TYPE_1997",
    "CV_HGC_BIO_DAD_1997",
    "CV_HGC_BIO_MOM_1997",
    "Highest.Grade_RES_DAD_1997", #CV_HGC_RES_DAD_1997
    "Highest.Grade_RES_MOM_1997", #CV_HGC_RES_MOM_1997
    "Race",
    "YSCH-6800_1998",
    "YSCH-7300_1998",
    "Ever_Used_Coca_1998", #YSAQ-372B_1998
    "YSAQ-371_2000",
    "Disorganized_2002", #YSAQ-282J_2002
    "YSAQ-282Q_2002",
    "HH_NET_WORTH_Y_2003", #CV_HH_NET_WORTH_Y_2003
    "CV_BA_CREDITS.01_2004",
    "YSAQ-000B_2004", 
    "YSAQ-373_2004",
    "Marijuana_2005", #YSAQ-369_2005
    "Children_HH_2007", #CV_BIO_CHILD_HH_2007
    "YTEL-52~000001_2007",
    "YTEL-52~000002_2007",
    "YTEL-52~000003_2007",
    "YTEL-52~000004_2007",
    "Children_HH_2009", #CV_BIO_CHILD_HH_2009
    "CV_COLLEGE_TYPE.01_2011",
    "Family_Income_2011", #CV_INCOME_FAMILY_2011
    "CV_HH_SIZE_2011",
    "CV_HH_UNDER_18_2011",
    "CV_HH_UNDER_6_2011",
    "Highest_Degree_Prior_2011.12", #CV_HIGHEST_DEGREE_1112_2011
    "Children_HH_2011", #CV_BIO_CHILD_HH_2011
    "Highest_Grade_Completed_2011", #YSCH-3112_2011
    "Height.Feet_2011", #YSAQ-000A000001_2011
    "Height.Inch_2011", #YSAQ-000A000002_2011
    "Weight.Pound_2011", #YSAQ-000B_2011
    "YSAQ-360C_2011",
    "YSAQ-364D_2011",
    "YSAQ-371_2011", 
    "Hard.drugs.DLI_2011", #YSAQ-372CC_2011
    "YSAQ-373_2011",
    "YSAQ-374_2011",
    "Industry_Code_2011", #YEMP_INDCODE-2002.01_2011
    "Children_HH_2015", #CV_BIO_CHILD_HH_2015
    "Industry_Code_2017", #YEMP_INDCODE-2002.01_2017
    "Occupation_Code_2017", #YEMP_OCCODE-2002.01_2017
    "MaritalStatus_2017", #CV_MARSTAT_COLLAPSED_2017
    "YINC-1400_2017",
    "Income",
    "YINC-1800_2017", 
    "YINC-2400_2017",
    "YINC-2600_2017",
    "YINC-2700_2017",
    "CVC_YTH_REL_HH_AGE6_YCHR_XRND",
    "CVC_SAT_MATH_SCORE_2007_XRND",
    "CVC_SAT_VERBAL_SCORE_2007_XRND",
    "CVC_ACT_SCORE_2007_XRND",
    "HH_NET_WORTH_20", #CVC_HH_NET_WORTH_20_XRND
    "HH_NET_WORTH_25", #CVC_HH_NET_WORTH_25_XRND
    "ASSETS_FINANCIAL_25", #CVC_ASSETS_FINANCIAL_25_XRND
    "ASSETS_DEBTS_20", #CVC_ASSETS_DEBTS_20_XRND
    "HH_NET_WORTH_30", #CVC_HH_NET_WORTH_30_XRND
    "CVC_HOUSE_VALUE_30_XRND",
    "CVC_HOUSE_TYPE_30_XRND",
    "ASSETS_FINANCIAL", #CVC_ASSETS_FINANCIAL_30_XRND
    "ASSETS_DEBTS_30") #CVC_ASSETS_DEBTS_30_XRND

### Set all negative values to NA.  
### THIS IS DONE ONLY FOR ILLUSTRATIVE PURPOSES
### DO NOT TAKE THIS APPROACH WITHOUT CAREFUL JUSTIFICATION
nlsy[nlsy < 0]  <- NA
```

#### A note on missing values

Here's an example of what the variable description files look like

```
T76400.00    [YSAQ-372CC]                                   Survey Year: 2011
  PRIMARY VARIABLE

 
             HAS R USED COCAINE/HARD DRUGS SINCE DLI?
 
Excluding marijuana and alcohol, since the date of last interview, have you used
any drugs like cocaine, crack, heroin, or crystal meth, or any other substance 
not prescribed by a doctor, in order to get high or to achieve an altered state?
 
UNIVERSE: All except prisoners in an insecure environment
 
     215       1 YES   (Go To T76401.00)
    7023       0 NO
  -------
    7238
 
Refusal(-1)           74
Don't Know(-2)        26
TOTAL =========>    7338   VALID SKIP(-4)      85     NON-INTERVIEW(-5)    1561
 
Min:              0        Max:              1        Mean:                 .03
 
Lead In: T76397.00[Default] T76399.00[Default]  T76398.00[0:0]
Default Next Question: T76403.00
```

This description says that the numbers -1, -2, -4 and -5 all have a special meaning for this variable.  They denote different types of missingness.  You can recode all of these to `NA`, but you should also think about whether the different missigness indicators are in some way informative.  (i.e., if someone refuses to answer questions related to drug use, might this inform us about their income?) 

#### Getting to know our two main variables.
<font color="#800000">
In the previous chunk of code we have appropriately renamed the variables corresponding to `sex`, `race` and `income` (as reported on the 2017 survey).  Let's have a quick look at what we're working with.
</font>
```{r, warning = FALSE}
table(nlsy$Sex)

table(nlsy$Race)
```
<font color="#800000">
The data codebook tells us that the coding for sex is `Male = 1`, `Female = 2`.  For the race/ethnicity variable, the coding is:
</font>
```
1 Black
2 Hispanic
3 Mixed Race (Non-Hispanic)
4 Non-Black / Non-Hispanic
```
<font color="#800000">
we will do data manipulations as we go to change away from the numeric codings to labels that can be interpreted better. 
</font>
```{r, warning = FALSE}
summary(nlsy$Income)

# Histogram
qplot(nlsy$Income) + labs(x="Income in $", y="Frequency", title="Histogram for Income")
```

<font color="#800000">
The income distributing is right-skewed like one might expect.  However, as indicated in the question description, the income variable is *topcoded* at the 2% level.  More precisely,
</font>

```{r, warning = FALSE}
n.topcoded <- with(nlsy, sum(Income == max(Income, na.rm = TRUE), na.rm = TRUE))
n.topcoded
```

`r n.topcoded` of the incomes are topcoded to the maximum value of `r max(nlsy$income, na.rm = TRUE)`, which is the average value of the top `r n.topcoded` earners. You will want to think about how  to deal with this in your analysis.

<font color="#800000">
We begin our analysis by including only the variables we have shortlisted into a data-set for consistency. The trends that seem most interesting to us for further exploration in assessing what impacts income gap between genders are: Marital Status (`MaritalStatus_2017`), Highest Grade Completed, Industry, Number of Biological Children, House-hold Net Worth at 30 and a digression towards Marijuana Use. Furthermore, we would like to see whether there is an impact of physical appearance on the income gap by using Body Mass Index (BMI). 
</font>



```{r, warning = FALSE}
nlsy.recode <- nlsy %>%
  mutate(Sex = recode_factor(Sex,
                                `1` = "Men",
                                `2` = "Female",
                                `0` = "No Information"))
nlsy.recode <- select(nlsy.recode, Marijuana_1997, PerCh.Dip.20_1997, PerCh.Baby_1997, PerCh.Coll.Degree.30_1997, Sex, BDATE_M_1997, BDATE_Y_1997, Dep_F_1997, Dep_M_1997, HH_NET_WORTH_P_1997, 
 Highest.Grade_RES_DAD_1997,Highest.Grade_RES_MOM_1997,Ever_Used_Coca_1998, Disorganized_2002,
 HH_NET_WORTH_Y_2003,
 Marijuana_2005, 
  Children_HH_2007,
  Children_HH_2009, 
  Family_Income_2011, 
  Highest_Degree_Prior_2011.12,
  Children_HH_2011, 
  Highest_Grade_Completed_2011,
  Height.Feet_2011,
  Height.Inch_2011,
  Weight.Pound_2011,
  Hard.drugs.DLI_2011,
  Industry_Code_2011,
  Children_HH_2015,
  Industry_Code_2017,
  Occupation_Code_2017,
  MaritalStatus_2017,
  Income,
  HH_NET_WORTH_20,
  HH_NET_WORTH_25,
  ASSETS_FINANCIAL_25,
  ASSETS_DEBTS_20,
  HH_NET_WORTH_30,
  ASSETS_FINANCIAL,
  ASSETS_DEBTS_30
 )
```

<font color="#800000">
As we are going to be analyzing income across all our variables, we will be removing NAN values from the rows within that variable. 
</font>

```{r, warning = FALSE}
nlsy.recode <- filter(nlsy.recode, !is.na(Income)) # 
```  

<font color="#800000">
Let's assess a summary table of income across gender. 
</font>

```{r, warning = FALSE}
income.gender <- nlsy.recode %>%
  group_by(Sex) %>%
  summarize(average.income = mean(Income), 
            median.income = median(Income))
respondents <- table(nlsy.recode$Sex)
kable(income.gender, format = "markdown", digits = 3)
```

<font color="#800000">
When assessing the data via a preliminary scan, we see that the average income for men is `r income.gender$average.income[1]` and the average income for women is `r income.gender$average.income[2]`, which amounts to a difference of `r income.gender$average.income[1] - income.gender$average.income[2]`.
</font>

```{r, warning = FALSE}
ggplot(nlsy.recode, aes(Income, fill = Sex)) + geom_histogram(alpha = 0.5, position = 'identity') +
  labs (x = "Income", y = "Number of Respondents", title = "Income histogram by Sex")
```

<font color="#800000">
After removing the NAN values in income. the number of female respondents is (`r respondents[2]`) compared to men (`r respondents[1]`). With the histogram, we see as the income progresses on the x-axis; men take the lead in reporting higher salaries; whereas, in the lower range, women seem to be the higher number of respondents. Furthermore, it is important to note that it seems like the data is left-skewed. Let's move on to assess income gaps and gender with other variables. First up, is Marital Status.

Income, Sex, and Marital Status:
Would you expect a single man to earn more than a single woman? Or could a divorced man earn more than a divorced woman? Our expectation would be that marital status should not affect income gap. There could; however, be a dent in the income gap if a married woman decides to take the role of a home-maker or a part-time job as per societal expectations. Let's find out.
</font>

```{r, warning = FALSE}
nlsy.recode <- filter(nlsy.recode, !is.na(MaritalStatus_2017)) #removing NAN values or no responses from our analysis variable. 

nlsy.recode <-mutate(nlsy.recode, MaritalStatus_2017 = recode_factor(MaritalStatus_2017,
                                `0` = "Never-married",
                                `1` = "Married",
                                `2` = "Separated",
                                `3` = "Divorced",
                                `4` = "Widowed",
                                `NA` = "Other"))

income.gender.2<- nlsy.recode %>%
  group_by(Sex, MaritalStatus_2017) %>%
  summarize(average.income = mean(Income))

income.gender.2
```

<font color="#800000">
The simple summary showcases that the variable is worth exploring. In most instances across marital groups, the average income of men is higher than women. By running a t-test we can get more concrete information. 
</font>

```{r, warning = FALSE}

income.gap.marital <- nlsy.recode %>%
  group_by(MaritalStatus_2017) %>%
  summarize(Income.gap = mean(Income[Sex == "Men"]) -  mean(Income[Sex == "Female"]),
            lower = (t.test(x = Income[Sex == "Men"], y = Income[Sex == "Female"]))$conf.int[1],
            upper = (t.test(x = Income[Sex == "Men"], y = Income[Sex == "Female"]))$conf.int[2],
            is.significant = as.numeric(t.test(Income ~ Sex)$p.value < 0.05), .groups = "keep")

income.gap.marital
```

<font color="#800000">
The income.gap variable shows us the difference between average salaries of men and women in the specified marital groups. 
</font>

```{r, warning = FALSE}
marital.gap <- ggplot(data = income.gap.marital,aes(x = reorder(MaritalStatus_2017, Income.gap), y = Income.gap))
marital.gap + geom_bar(position="dodge", stat="identity")  + geom_errorbar(aes(ymin = lower, ymax = upper), width=.2, position = position_dodge(0.9)) +  theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + labs(x = "Marital Status", y = "Income Gap Between Genders", title = "Income Gap with Error Bars")
```

<font color="#800000">
The error bars are below the 0-axis, therefore according to the data the results are not statistically significant. Running a regression model should corroborate our initial findings. First, we will run a simple regression on just income and sex; following which we will include marital status in the model
</font>

```{r, warning = FALSE}
lm.income.sex <- lm(Income ~ Sex, data = nlsy.recode)
summary(lm.income.sex)
```

<font color="#800000">
From the simple regression, it seems that on average women earn `r round(coef(lm.income.sex)["SexFemale"], 0)*-1` less than men. This seems to be statistically significant with a p-value of `r lm.income.sex$p.value`
</font>

```{r, warning = FALSE}
lm.income.sex.marital <- lm(Income ~ Sex + MaritalStatus_2017, data = nlsy.recode)
summary(lm.income.sex.marital)
```

<font color="#800000">
All else considered constant, It seems that on average a married person earns `r round(coef(lm.income.sex.marital)["MaritalStatus_2017Married "], 0)` more than the baseline (never-married). This seems to be statistically significant with a p-value of `r lm.income.sex.marital$p.value`.
</font>

```{r, warning = FALSE}
anova(lm.income.sex , lm.income.sex.marital)
```

<font color="#800000">
From the analysis of variance table, we see that including marital status to gender has an impact on the income gap and it is significant.   
</font>

```{r, warning = FALSE}
lm.marital.interact <- update(lm.income.sex.marital, .~. + MaritalStatus_2017 * Sex)
summary(lm.marital.interact)
```

<font color="#800000">
This interactive model corresponds to differences in earnings across gender and marital status that are not accounted for by a model that assumes independent effects for Marital status and gender. For instance, here we only see that the income difference among married men and married women is `r round(abs(coef(lm.marital.interact)["SexFemale:MaritalStatus_2017Married "]),0)*-1` less than the difference between single men and single women. However, we cannot conclude that marital status as a whole is a factor that is highly associated with the income gap between men and women. 
</font>


<font color="#800000">
A natural shift from marriage would be children. Income, sex and number of children. Would you expect income gap to decrease regardless of gender as the family size increases? There are multiple theories that come into play here. Perhaps contributing factors could be a sense of income security leading to both genders having more children. On the flip side, the gap could exacerbate given that more and more women on average might switch to more lax jobs or choose to stay at home altogether. We think this is an interesting variable to explore.

In order to , we have chosen the "biological children in household data" from 2009. We checked the data and it seemed to be replicated for all the years. We will run simple summaries and check for associations, next we will run a simple regression model to check for significance, and finally explore if there are any interactions between highest grade completed, number of children, sex and income.  
</font>

```{r, warning = FALSE}
num.bio.child <- nlsy.recode %>%
  group_by(Children_HH_2009, Sex) %>%
  summarize(average.income = mean(Income, na.rm = TRUE))

num.bio.child <- filter(num.bio.child, !is.na(average.income),!is.na(Children_HH_2009))
num.bio.child
```

<font color="#800000">
We see a pattern, men's income on average increases up to 3 biological children. The gap in income between men and women remains; let's leave gender out of it and see if there's a variance in average income regardless as the number of children increase. 
</font>

```{r, warning = FALSE, fig.height = 4, fig.width = 9}
ggplot(data = num.bio.child, aes(x = Children_HH_2009, y = average.income, fill = Sex)) + 
  geom_bar(position="dodge", stat="identity") +
  theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + 
  labs( x = "Number of Biological Children", y = "Average Income ($)", title="Number of biological childern vs. Average Income (Grouped by Sex)")
```

<font color="#800000">
We see a pattern, men's income on average increases up to 3 biological children. The gap in income between men and women remains; let's leave gender out of it and see if there's a variance in average income regardless as the number of children increase. 
</font>


```{r, warning = FALSE, fig.height = 4, fig.width = 9}
ggplot(data = num.bio.child, aes(x = Children_HH_2009, y = average.income)) + 
  geom_bar(position="dodge", stat="identity") +
  theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + 
  labs( x = "Number of Biological Children", y = "Average Income ($)", title = "Number of biological childern vs. Average Income")
```

<font color="#800000">
Again, regardless of gender the pattern showcases that the average income increases up to 3 children. Let's get to the notorious question of income gap! For this analysis, we will take out the outlier reported for people with six children or more ($2,500 for men).
</font>

```{r, warning = FALSE}
nlsy.child.recode <- filter(nlsy.recode, !(Children_HH_2009 == 6))

gap.data.conf.child <- nlsy.child.recode %>%
  group_by(Children_HH_2009) %>%
  summarize(income.gap = mean(Income[Sex == "Men"], na.rm = TRUE) -
              mean(Income[Sex == "Female"], na.rm = TRUE),
            lower = t.test(Income ~ Sex)$conf.int[1],
            upper = t.test(Income ~ Sex)$conf.int[2],
            is.significant = as.numeric(t.test(Income ~ Sex)$p.value < 0.05), .groups = "keep")
gap.data.conf.child
```

```{r, warning = FALSE}
#Plot, with error bars
ggplot(data = gap.data.conf.child, aes(x = Children_HH_2009, y = income.gap,
                            fill = is.significant)) +
  geom_bar(stat = "identity") +
  xlab("Biological Children in Household") + 
  ylab("Income gap($)") +
  ggtitle("Income gap between men and women, by children") + 
  guides(fill = FALSE) +
  geom_errorbar(aes(ymax = upper, ymin = lower), width = 0.1, size = 1) +
  theme(text = element_text(size=12)) 
```

<font color="#800000">
The graph above shows that the income gap seems to be the widest with three biological children in the household. Since the error bars do not cross the 0-axis, it's statistically significant.     
</font>

```{r, warning = FALSE}
#running a simple regression model for Income, Biological Children and Sex 
income.lm.bio.child.sex <- lm(Income ~ Sex + Children_HH_2009, data = nlsy.child.recode)
summary(income.lm.bio.child.sex)
```

<font color="#800000">
From the simple regression, it seems that on average with each additional child respondents earn $`r round(coef(income.lm.bio.child.sex)["Children_HH_2009"], 0)` more. This is a very small number and is statistically insignificant. 
</font>

```{r, warning = FALSE}
anova(update(income.lm.bio.child.sex, . ~ . -Children_HH_2009),income.lm.bio.child.sex)
```

<font color="#800000">
From the analysis of variable table, children are not statistically significant predictor of income in the model. We also want to explore the interactive model:
</font>

```{r, warning = FALSE}
lm.child.interact <- update(income.lm.bio.child.sex , .~. + Children_HH_2009 * Sex)
summary(lm.child.interact)
```

<font color="#800000">
When we put these variables to the test, it shows a highly significant finding. This interactive model corresponds to differences in earnings across gender and biological children in household that are not accounted for by a model that assumes independent effects of each. It seems that on average the income difference between women with children and men with children is $`r round(coef(lm.child.interact )["SexFemale:Children_HH_2009"], 0)*-1` less than the difference between women and men that don't have children. This finding is highly significant according to the data. It's also interesting to note that now each additional child brings in `r round(coef(lm.child.interact )["Children_HH_2009"], 0)` more with income and it is statistically significant in the interaction.
</font>

<font color="#800000">
Income, Sex, and Highest Grade Completed:
We expect to see an impact on income gap and the highest degree completed. We want to explore whether this difference prevails regardless of gender. The question here would be, does it matter whether you are male or female if the highest degree you have completed is the same across both genders? Our first approach is to check the continuity of the data of highest grade against income without re-coding it as a factor variable. We take advantage of the fact that the Highest Degree Completed variable is in a chronological order and we skipped the number 95 where the respondents had mentioned their degree to be "ungraded". 
 </font>

```{r, warning = FALSE}
ggplot(data = nlsy.recode, aes(x = Highest_Grade_Completed_2011, y = Income , colour = Sex )) + geom_point() + stat_smooth(method = 'loess', formula = y ~ x, size = 1) + theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + xlim(0,22) + 
  labs( x = "Highest Degree Completed", y = "Average Income ($)", title="Highest Degree Completed vs. Average Income (Grouped by Sex)")
```

<font color="#800000">
In the graph, we can see an evolution of the income gap between men and women, depending on the highest degree completed. The income difference between men and women becomes smaller as the degree completed approaches 12, that is "12th grade" or equivalent to a high school diploma.
</font>


```{r, warning = FALSE}
nlsy.recode <- mutate(nlsy.recode,Highest_Grade_Completed_2011 = recode_factor(Highest_Grade_Completed_2011,
                                             `0` = "NONE",
                                             `1` = "1ST GRADE",
                                             `2` = "2ND GRADE",
                                             `3` = "3RD GRADE",
                                             `4` = "4TH GRADE",
                                             `5` = "5TH GRADE",
                                             `6` = "6TH GRADE",
                                             `7` = "7TH GRADE",
                                             `8` = "8TH GRADE",
                                             `9` = "9TH GRADE",
                                             `10` = "10TH GRADE",
                                             `11` = "11TH GRADE",
                                             `12` = "12TH GRADE",
                                             `95` = "UNGRADED",
                                             `13` = "1ST YEAR COLLEGE",
                                             `14` = "2ND YEAR COLLEGE",
                                             `15` = "3RD YEAR COLLEGE",
                                             `16` = "4TH YEAR COLLEGE",
                                             `17` = "5TH YEAR COLLEGE",
                                             `18` = "6TH YEAR COLLEGE",
                                             `19` = "7TH YEAR COLLEGE",
                                             `20` = "8TH YEAR COLLEGE OR MORE"))


income.lm.sex.degree <- lm(Income ~ Sex + Highest_Grade_Completed_2011, data = nlsy.recode)
summary(income.lm.sex.degree)
```

<font color="#800000">
All else considered constant, the regression does not show us anything that is statistically significant across the different grade completed levels. We do still want to see if there is an interaction between gender and highest degree completed for income gap 
</font>


```{r, warning = FALSE}
high.grade <- table(nlsy.recode$Highest_Grade_Completed_2011)
nlsy.lm.interact.degree <- update(income.lm.sex.degree, . ~ . + Highest_Grade_Completed_2011*Sex)
summary(nlsy.lm.interact.degree)
```

<font color="#800000">
This interactive model corresponds to differences in earnings across gender and the highest grade completed that are not accounted for by a model that assumes independent effects for highest grade completed and gender. We notice that now the variable highest grade completed as "4th Grade" becomes statistically significant. The coefficient here of `r round(abs(coef(nlsy.lm.interact.degree )["Highest_Grade_Completed_20114TH GRADE"]),0)`  and in the interaction variable of `r round(abs(coef(nlsy.lm.interact.degree)["SexFemale:Highest_Grade_Completed_20114TH GRADE"]),0)` will not make sense and show us nothing because the number of observations for the 4th Grade in our data-set at this point is only `r high.grade["4TH GRADE"]`. The interaction term for "second year college and female" shows us that the income difference between women who have completed 2nd year of college and men who have completed 2nd year of college is `r round(abs(coef(nlsy.lm.interact.degree )["SexFemale:Highest_Grade_Completed_20112ND YEAR COLLEGE" ]),0)` more than the difference between women and men with no grades completed.
</font>

<font color="#800000">
Moving forward we want to explore whether industries are related to an income gap between genders. With the following basis:

Income, Sex, and Industry: Is there a discrimination in Income across genders in specific Industries? Typically, male-centric industries like mining, construction and manufacturing would not see higher salaries for women. However, in the entertainment industry or perhaps financial institutions; where both genders contribute; could we possibly see a difference in their earnings? 
</font>

```{r, warning = FALSE}
industry.decoder <- c(rep(' AGRICULTURE, FORESTRY AND FISHERIES',121),rep('NA',79),
                    rep(' MINING',121),rep('NA',79),rep(' UTILITIES',121),
                    rep('NA',79),rep('CONSTRUCTION',1),rep('NA',299),
                    rep(' MANUFACTURING',2921),rep('NA',79),rep(' WHOLESALE TRADE',521),
                    rep('NA',79),rep(' RETAIL TRADE',1121),rep('NA',99),
                    rep(' ARTS, ENTERTAINMENT AND RECREATION SERVICES',1),
                    rep('NA',179),rep(' TRANSPORTATION AND WAREHOUSING',321),
                    rep('NA',79),rep(' INFORMATION AND COMMUNICATION',311),
                    rep('NA',89),rep(' FINANCE, INSURANCE, AND REAL ESTATE',321),
                    rep('NA',79),rep(' PROFESSIONAL AND RELATED SERVICES',521),
                    rep('NA',69),rep(' EDUCATIONAL, HEALTH, AND SOCIAL SERVICES',611),
                    rep('NA',89),rep(' ENTERTAINMENT, ACCOMODATIONS, AND FOOD SERVICES',131),
                    rep('NA',79),rep(' OTHER SERVICES',521),rep('NA',79),
                    rep(' PUBLIC ADMINISTRATION',221),rep('NA',79),
                    rep(' ACTIVE DUTY MILITARY',221),rep('NA',59),rep(' ACS SPECIAL CODES',41))
names(industry.decoder)<-170:9990

decode <- function(number) {
  if (is.na(industry.decoder[as.character(number)])) 
  {  text <- "OTHER"   }
  else {
    text <- industry.decoder[as.character(number)]   }
  return (text)}

nlsy.recode[["Industry_Code_2017"]] <- sapply(nlsy.recode[["Industry_Code_2017"]], decode)
```

<font color="#800000">
First, we look at the general average income in each industry irrespective of gender, showcased by the plot below.
</font>

```{r, warning = FALSE,fig.height = 8, fig.width = 15}
#general average income without gender grouping
income.industries.avg <- nlsy.recode %>%
  group_by(Industry_Code_2017) %>%
  summarize(average.income = mean(Income, na.rm = TRUE), .groups = 'keep')

#average income across industries with gender grouping
income.industries.sex <- nlsy.recode %>%
  group_by(Sex, Industry_Code_2017) %>%
  summarize(average.income = mean(Income, na.rm = TRUE), .groups = 'keep')


ggplot(income.industries.avg, aes(x = reorder(Industry_Code_2017, average.income), y = average.income, fill = Industry_Code_2017)) + geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1)) + labs( x = "Industry", y= "Average Income in $", title = "Industry-wise Average Income Distribution")
```

<font color="#800000">
It seems like the average income in the mining industry is the highest versus accomodations and food services at the lowest point in the given data-set. Since, we already have information available for 2011 in the data-set, we want to explore if the income gap has changed over time within industries before we examine it specifically for 2017.
</font>

```{r, warning = FALSE}
#preliminary re-coding for Industries for 2011 and simple summaries:
nlsy.recode[["Industry_Code_2011"]] <- sapply(nlsy.recode[["Industry_Code_2011"]], decode)

#general average income without gender grouping
income.industries.avg.2011 <- nlsy.recode %>%
  group_by(Industry_Code_2011) %>%
  summarize(average.income = mean(Income, na.rm = TRUE), .groups = 'keep')

#average income across industries with gender grouping
income.industries.sex.2011 <- nlsy.recode %>%
  group_by(Sex, Industry_Code_2011) %>%
  summarize(average.income = mean(Income, na.rm = TRUE), .groups = 'keep')
```

```{r, warning = FALSE}
income.industries.sex.2011$year = 2011
income.industries.sex$year = 2017 

income.industries.sex.2011.r <- income.industries.sex.2011 %>% 
  rename(Industry = Industry_Code_2011)

income.industries.sex.2017.r <- income.industries.sex %>% 
  rename(Industry = Industry_Code_2017)

ind.income.sex.time <- rbind(income.industries.sex.2017.r, income.industries.sex.2011.r)
```

```{r, warning = FALSE,fig.height = 10, fig.width = 15}
ggplot(data = ind.income.sex.time, aes(x = year, y = average.income, color = Sex)) +
  facet_wrap( ~ Industry) +
  geom_point() +
  geom_smooth(method = "lm") + labs(x = "Year", y = "Average Income", title = "Year vs. Average Income (Grouped by Sex and Industry)")
```

<font color="#800000">
The graphs are beautiful! They show the average incomes between 2011 and 2017 (considering only the two data-points) differentiated by sex; this allows us to see the gaps between the incomes. Generally, the income gaps are lowering overtime between the genders; however, we cannot say that our claim is statistically significant. It is interesting to see that there's a large gap in average income for the finance, insurance and the real estate sector as we had previously hypothesized. 

Now that we've examined the average income overtime; lets be more specific in the income gap assessment for the later year of 2017.
</font>



```{r, warning = FALSE}
nlsy.recode.ind <- filter(nlsy.recode, !(Industry_Code_2017 == " ACTIVE DUTY MILITARY"))
  
gap.data.conf.ind <- nlsy.recode.ind %>%
  group_by(Industry_Code_2017) %>%
  summarize(income.gap = mean(Income[Sex == "Men"], na.rm = TRUE) -
              mean(Income[Sex == "Female"], na.rm = TRUE),
            lower = t.test(Income ~ Sex)$conf.int[1],
            upper = t.test(Income ~ Sex)$conf.int[2],
            is.significant = as.numeric(t.test(Income ~ Sex)$p.value < 0.05), .groups = "keep")
gap.data.conf.ind
```
```{r, warning = FALSE,fig.height = 8, fig.width = 15}
ggplot(gap.data.conf.ind, aes(x = reorder(Industry_Code_2017, income.gap), y = income.gap, fill = Industry_Code_2017)) + geom_bar(stat = "identity") +
  theme(axis.text.x = element_text(angle = 60, vjust = 1, hjust = 1)) + labs( x = "Industry", y= "Income Gap") + ggtitle("Income gap between men and women, by Industry") + geom_errorbar(aes(ymax = upper, ymin = lower), width = 0.1, size = 1)
```

<font color="#800000">
We notice the highest income gap is in the financial and real estate institutions and this gap is statistically significant. However, if we look at industries such as wholesale trade, mining, utilities and information&communications, the error bars cross the 0-axis and this shows that the income gap here is not statistically significant. We will now move on to running regressions:  
</font>


```{r, warning = FALSE}
income.lm.grade.ind.sex <- lm(Income ~ Sex + Industry_Code_2017, data = nlsy.recode)
summary(income.lm.grade.ind.sex)
```

<font color="#800000">
There are 9 statistically significant coefficients across the industries. We are going to explore the interaction term with gender.
</font>


```{r, warning = FALSE}
anova(update(income.lm.grade.ind.sex , . ~ . - Industry_Code_2017), income.lm.grade.ind.sex)
```

<font color="#800000">
Industries turn out to be a highly statistically significant predictor of income in the model. You can see this also by looking at the coefficient estimates and standard errors â€” the estimated coefficients are very large, with relatively small standard errors. 
</font>


```{r, warning = FALSE}
nlsy.lm.interact.ind <- update(income.lm.grade.ind.sex, . ~ . + Industry_Code_2017*Sex)
summary(nlsy.lm.interact.ind)
```

<font color="#800000">
The income difference among women and men in the finance, insurance and real estate industry is `r round(abs(coef(nlsy.lm.interact.ind)["SexFemale:Industry_Code_2017 FINANCE, INSURANCE, AND REAL ESTATE "]),0)*-1` less than the difference between women and men in the baseline defined here as ACS Special codes. 
</font>


<font color="#800000">
Though part of the unconventional debate, there are studies that examine the impact of physical appearance on the income gap. To narrow down our analysis, we are going to assess physical appearance through the Body Mass Index (BMI) parameters stated below and evaluate it with the assumption that those that fall within a normal range are physically attractive and thus might earn more regardless of gender. Let's explore this further. 

If your BMI is less than 18.5: it falls within the underweight range. 
If your BMI is 18.5 to <25, it falls within the normal. 
If your BMI is 25.0 to <30, it falls within the overweight range. 
If your BMI is 30.0 or higher, it falls within the obese range.
</font>

```{r, warning = FALSE}
nlsy.recode <- filter(nlsy.recode, !is.na(Height.Inch_2011), !is.na(Weight.Pound_2011), !is.na(Height.Feet_2011))
nlsy.recode$bmi <- (703 * nlsy.recode$Weight.Pound_2011) / ((nlsy.recode$Height.Feet_2011*12) + nlsy.recode$Height.Inch_2011)**2
```

```{r, warning = FALSE}
ggplot(nlsy.recode, aes(x=bmi, y=Income, color=Sex)) + geom_point(size=0.2) + xlim(10,60) + geom_smooth(method="lm", se=FALSE) + labs(x="Body Mass Index (BMI)", y="Income in $", title = "BMI vs. Income (Grouped by Sex)")
```

<font color="#800000">
The graph above shows us that an income gap remains between men and women across varying BMIs. As the BMI increases, the income gap widens. This can also be analyzed through a simple regression model as well. 
</font>

```{r, warning = FALSE}
lm.bmi <- lm(Income ~ Sex + bmi, data = nlsy.recode)
summary(lm.bmi)
```

<font color="#800000">
With each unit increase in the body mass index (BMI), the income decreases by `r round(abs(coef(lm.bmi)["bmi"]),0)*-1`.
</font>

```{r, warning = FALSE}
anova(update(lm.bmi, . ~ . - bmi), lm.bmi)
```

<font color="#800000">
BMI turns out to be statistically significant predictor of income in the model. We want to see the interaction term with gender. 
</font>

```{r, warning = FALSE}
lm.bmi.interact <- update(lm.bmi, . ~ . + Sex*bmi)

summary(lm.bmi.interact)
```

<font color="#800000">
The interaction term SexFemale:bmi negative coefficient shows that with each unit increase in BMI the income gap increases. 
</font>

<font color="#800000">
We want to explore whether the use of cocaine will affect income. We think that the use of cocaine will affect income levels regardless of gender; however, it will not have an impact on the income gap. This time we are not going to delete the NA values in the data, because those people chose not to respond and it could fall under any of the two categories: users vs those that have never used. We'll start with a simple summary table of the income gap. 
</font>

```{r, warning = FALSE}
nlsy.recode <- mutate(nlsy.recode,Ever_Used_Coca_1998 = recode_factor(Ever_Used_Coca_1998,
                                             `0` = "No",
                                             `1` = "Yes"))
qplot(data = nlsy.recode, geom = "boxplot", x = Ever_Used_Coca_1998, y = Income, fill = Ever_Used_Coca_1998) + labs(x = "Ever Used Cocaine", y="Income in $", title = "Bar Plot of Cocaine Usage")
```

<font color="#800000">
In the previous box-plot, we can see that the average income is the same regardless of whether you have used cocaine.
</font>

```{r, warning=FALSE}
coca.income <- ggplot(nlsy.recode, aes(x = Income))
coca.income + geom_density(aes(fill = Ever_Used_Coca_1998), alpha = 0.3) + scale_color_manual(values = c("#999999", "#E69F00", "#56B4E9")) + scale_fill_manual(values = c("#999999", "#E69F00", "#56B4E9")) + labs(x="Income in $", y="Respondent density", title="Density Function for Income (Group by Cocaine Usage)")
```

<font color="#800000">
The continuous frequency distribution also tells us that the mean income values are approximately the same with the data left skewed (as expected because it is for income). A final check of significance is the linear regression model.
</font>

```{r, warning = FALSE}
coca.income.lm <- lm(Income ~ Sex + Ever_Used_Coca_1998, data = nlsy.recode)
summary(coca.income.lm)
```
  
<font color="#800000">
As seen from the regression and graphs above, cocaine consumption does not have a significant effect on income.

Now let's see the household worth for the respondents at age of 30. 
</font>


```{r, warning = FALSE}
worth.30.means <- nlsy.recode %>%
  group_by(Sex) %>%
  summarize(hh.worth.30 = mean(HH_NET_WORTH_30, na.rm = TRUE),
            lower = t.test(HH_NET_WORTH_30, na.rm = TRUE)$conf.int[1],
            upper = t.test(HH_NET_WORTH_30, na.rm = TRUE)$conf.int[2],
            is.signif = as_factor(
              if (lower<0 & upper>0){
                is.signif = 0
              } else {
                is.signif = 1
              }
            ), .groups = 'keep')

worth.30.means.plot <- ggplot(data = worth.30.means,
                              aes(x = Sex, y = hh.worth.30,
                                  fill = Sex))
worth.30.means.plot + geom_bar(position="dodge", stat="identity") +
  guides(fill = guide_legend(title = "Sex")) +
  geom_errorbar(aes(ymin = lower, ymax = upper), 
                width=.2, position = position_dodge(0.9)) +
  theme(axis.text.x=element_text(angle = 90, vjust = 0.5)) + labs(x = "Sex", y = "Household worth at age of 30", title = "Bar plot of Sex vs. Household Worth at 30")
```

<font color="#800000">
In the boxplot we can see than in average, household worth of the respondants at age of 30 is higher for men compared to female.
</font>

```{r, warning = FALSE}
ggplot(data = nlsy.recode, aes(x = HH_NET_WORTH_30, y = Income , colour = Sex )) + geom_point() + stat_smooth(method = 'loess', formula = y ~ x, size = 1) + theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + 
  labs( x = "Household worth at 30 years old", y = "Average Income ($)", title = "Household Worth at 30 vs. Average Income (Group by Sex)")
```

<font color="#800000">
Without having filtered the top coded incomes, we see that the gap in average income between men and women gets larger as the household worth at 30 yrs increases.
</font>

```{r, warning = FALSE}
ggplot(data = nlsy.recode, aes(x = Income, y = HH_NET_WORTH_30 , colour = Sex )) + geom_point() + stat_smooth(method = 'loess', formula = y ~ x, size = 1) + theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + 
  labs( x = "Average Income ($)", y = "Household worth at 30 years old", title = "Average Income vs. Household Worth at 30 (Group by Sex)")
```

<font color="#800000">
We want to see whether the average income somewhat determines household worth. We can see that females tend to have on average a higher sense of household worth when they have the same income as men.
</font>

```{r, warning = FALSE}
income.hh_worth.lm <- lm(Income ~ Sex + HH_NET_WORTH_30, data = nlsy.recode)
summary(income.hh_worth.lm)
```

<font color="#800000">
All else remaining constant, with each unit change in the household worth at 30, there is a very small change of `r round(abs(coef(income.hh_worth.lm )["HH_NET_WORTH_30"]),0)` in income. Regardless of gender.
</font>

```{r, warning = FALSE}
nlsy.lm.interact.hh.worth <- update(income.hh_worth.lm, . ~ . + HH_NET_WORTH_30*Sex)
summary(nlsy.lm.interact.hh.worth)
```

<font color="#800000">
The coefficient values `r round(abs(coef(nlsy.lm.interact.hh.worth)["HH_NET_WORTH_30"]),3)` are so small that we don't want to further in this analysis.

Now we are going to filter the top coded Income.
</font>

```{r, warning = FALSE}
nlsy.recode.inc.filt <- filter(nlsy.recode, !(Income > 150000))

hh30_Income.plot <- ggplot(data = nlsy.recode.inc.filt, aes(x = HH_NET_WORTH_30, y = Income , colour = Sex )) 

hh30_Income.plot + geom_point() + stat_smooth(method = 'lm', formula = y ~ x, size = 1) +
  theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) +
  labs( x = "Household worth at 30 years old", y = "Average Income ($)", title = "Average Income vs. Household Worth at 30 (Group by Sex)")
```

<font color="#800000">
The linear model for the average income after filtering the top coded incomes, shows that the higher the household worth, the larger the average income gap, without establishing that it is statistically significant. 
</font>

```{r, warning = FALSE}
Income_hh30.plot <- ggplot(data = nlsy.recode.inc.filt, aes(x = Income, y = HH_NET_WORTH_30 , colour = Sex )) 
Income_hh30.plot + geom_point() + stat_smooth(method = 'lm', formula = y ~ x, size = 1) + theme(axis.text.x=element_text(angle = 0, vjust = 0.5)) + 
  labs( x = "Average Income ($)", y = "Household worth at 30 years old", title = "Average Income vs. Household Worth at 30 (Group by Sex)")
```

<font color="#800000">
Considering again whether the average income somewhat determines household worth, having filtered the top-coded incomes, with the linear model, we can see that in average females have a larger household worth for the same income levels, without establishing this is statistically significant.
</font>

<font color="#800000">
Now we proceed further by analyzing how debt at the age of 30 (`ASSETS_DEBTS_30`) would affect income and inequality gap. Since the relevant column contains some `NA` values, we are cleaning the data by removing them. Additionally, analysis would have been affected by high income individuals (income outliers), hence, we are also removing them from the original data-set.
</font>

```{r, warning = FALSE}
nlsy.recode <- filter(nlsy.recode, !is.na(ASSETS_DEBTS_30), !(Income > 150000))
```

```{r, warning = FALSE}
ggplot(nlsy.recode, aes(x=ASSETS_DEBTS_30, y=Income, color=Sex)) + geom_point(size=0.2) + geom_smooth(method="loess", se=FALSE) + labs(x="Debt at the age of 30 (in $)", y="Income in $", title="Debt at 30 vs. Income (Group by Gender)")
```

<font color="#800000">
The above graph reflects that 'Debt at 30' and income have an inverted U relationship. The inequality gap between male and female gradually decreases as debt increases, but we need to check if it's statistically significant. Proceeding with regressions and other tests. 
</font>

```{r, warning = FALSE}
debts.lm <- lm(Income ~ Sex + ASSETS_DEBTS_30, data = nlsy.recode)
summary(debts.lm)
```

```{r, warning = FALSE}
anova(update(debts.lm, . ~ . - ASSETS_DEBTS_30), debts.lm)
```

<font color="#800000">
The linear regression shows that when considered independently, 'Debt at 30' has significant impact on mean income. To reaffirm the results, we performed ANOVA test and they also confirmed the same. (Compared two models - with and without 'Debt at 30'. The p-value indicates that it is significant in impacting income)

Lastly, we need to check if 'Debt at 30' has any impact in the income inequality gap. We check that by performing regression with interaction between 'Gender' and 'Debt at 30'.
</font>

```{r, warning = FALSE}
debts.lm.interact <- update(debts.lm, .~. + Sex*ASSETS_DEBTS_30)
summary(debts.lm.interact)
```

<font color="#800000">
The p-value from the above regression shows that when considered independently, Gender and Debt at 30, significantly impact income. But Debt at 30 is insignificant and changes income regardless of gender/sex.

Below plot confirms the same. We've removed gender from the analysis and we see that the relationship is still an inverted-U. 
</font>

```{r, warning = FALSE}
ggplot(nlsy.recode, aes(x=ASSETS_DEBTS_30, y=Income)) + geom_point(size=0.2) + geom_smooth(method="loess", se=FALSE) + labs(x="Debt at the age of 30 (in $)", y="Income in $", title="Debt at 30 vs. Income")
```

<font color="#800000">
We want to now plot all our variables against a final regression model. We've used eight variables in our analysis and regardless of whether they are significant or not we run the linear regression plots as a diagnostic tool.
</font>

```{r, warning=FALSE, fig.height = 6, fig.width = 10}
lm.final.all <- lm(Income ~ MaritalStatus_2017 + Children_HH_2011 + Highest_Grade_Completed_2011 + Industry_Code_2011 + Ever_Used_Coca_1998 + bmi + HH_NET_WORTH_30 + ASSETS_DEBTS_30, data = nlsy.recode)
par(mfrow = c(2, 2))
plot(lm.final.all)
```
<font color="#800000">
Residuals vs Fitted: very few residual values are away from the fitted line and most of them are clustered around the predicted regression line. Also as visible, the red line is approximately horizontal at zero. This shows us that our model has a good linear regression fit.

Normal QQ: This graph indicates if the residual values are normally distributed or not. Our model does fairly well on this parameter as well. 

Scale - Location: It can be seen that the variability (variances) of the residual points increases with the value of the fitted outcome variable, suggesting non-constant variances in the residuals errors (or heteroscedasticity).

Residuals vs Leverage: This graph shows the presence of outliers in the dependent and independent variables. Most of the data points are within the 3 standard deviation. This also conforms with the empirical rule.
</font>


<font color="#800000">
<b>In conclusion, even though we took eight variables from our data-set and they all fit the linear model to some degree. The most significant impact on income gap was seen for the interactive variables between Sex and Industry Code as well as Sex and Marital status; specifically for married women and men. In our analysis, we also thought to shed some light on the impact of physical appearance using BMI on income gap. This also proved to be statistically significant. We expected a significant impact of the highest grade completed on the income gap but it proved to be insignificant across all levels of education. Furthermore, the number of biological children ought to have shown a clear direction with the gap widening as the number of children increased. This also proved to be insignificant. The scope of this project limited the factor selection; however, if a larger pool of factors is considered, we believe the regression model would have had better results.</b>
</font>

